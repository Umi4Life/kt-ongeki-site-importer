(()=>{var x="__ktimport__",g="prod",A={prod:{baseUrl:"https://kamai.tachi.ac",clientId:"CI2a215ade610e60ee433a1f1faf0f2615f250e80d"}},h=A[g].baseUrl,C=A[g].clientId,I="api-key",N="https://ongeki-net.com/ongeki-mobile/",P=["BASIC","ADVANCED","EXPERT","MASTER","LUNATIC"],D=!1;function y(t){return localStorage.getItem(`${x}${t}_${g}`)}function b(t,e){localStorage.setItem(`${x}${t}_${g}`,e)}function l(t){let e=document.querySelector("#kt-import-status");e||(e=document.createElement("p"),e.id="kt-import-status",e.style.cssText="text-align: center; background-color: #fff;",document.querySelector(".title")?.insertAdjacentElement("afterend",e)),e.innerText=t}var E=class extends Error{constructor(r,o){super(`ONGEKI-NET error ${r}: ${o}`);this.errCode=r;this.errDescription=o}},L=class{constructor(e){this.baseUrl=e;this.domParser=new DOMParser,e.endsWith("/")||(this.baseUrl=e.substring(0,e.length-1))}domParser;async getPlaylog(){return this.request("/record/playlog/")}async sendPlaylogDetail(e){return this.request(`/record/playlogDetail/?idx=${e}`)}async sendMusicDifficulty(e){return this.request(`/record/musicGenre/search/?genre=99&diff=${e}`)}async sendMusicDetail(e){return this.request(`/record/musicDetail/?idx=${encodeURIComponent(e)}`)}async request(e,r){let o=`${this.baseUrl}${e}`,n=await fetch(o,r),i=new URL(n.url);if(n.status===503)throw l("ONGEKI.NET is currently under maintenance. Please try again later."),new Error("ONGEKI.NET is under maintenance");if(i.pathname.endsWith("/error/")){let s=this.domParser.parseFromString(await n.text(),"text/html").querySelectorAll(".block.text_l .font_small"),c=s[0],a=c?.textContent?Number(c.textContent.split(": ")[1]):-1,m=s.length>1&&s[1].textContent?s[1].textContent:"An unknown error occured.";throw l(`ONGEKI-NET error ${a}: ${m}`),new E(a,m)}if(i.pathname.includes("/rightLimit/")){let s=this.domParser.parseFromString(await n.text(),"text/html").querySelectorAll(".block.text_l .font_small"),c=s[0],a=c?.textContent?Number(c.textContent.split(": ")[1]):-1,m=s.length>1&&s[1].textContent?s[1].textContent:"Account has no subscription (https://gw.sega.jp/gateway/login/?product_name=ongeki).";throw l(`ONGEKI-NET error ${a}: ${m}`),new E(a,m)}return n}},f=new L(N);async function O(t){let{scores:e=[]}=t,r=JSON.parse(y("scores")??"[]");if(r.push(...e),b("scores",JSON.stringify(r)),r.length===0){l("Nothing to import.");return}let o={meta:{game:"ongeki",playtype:"Single",service:"site-importer"},scores:r};if(D&&g==="prod"){console.log("Currently in development mode. Scores will not be uploaded to Kamaitachi.");let s=new Blob([JSON.stringify(o,null,4)],{type:"application/json"}),c=URL.createObjectURL(s),a=document.createElement("a");a.href=c,a.download=`kt-ongeki-site-importer-${new Date().valueOf()}.json`,a.click();return}let n=JSON.stringify(o);document.querySelector("#kt-import-button")?.remove(),l("Submitting scores...");let i;try{i=await fetch(`${h}/ir/direct-manual/import`,{method:"POST",headers:{authorization:`Bearer ${y("api-key")}`,"content-type":"application/json","x-user-intent":"true"},body:n}).then(s=>s.json())}catch(s){l(`Could not submit scores to Kamaitachi: ${s}
Your scores are saved in browser storage and will be submitted next import.`);return}if(b("scores","[]"),b("classes","{}"),!i.success){l(`Could not submit scores to Kamaitachi: ${i.description}`);return}let u=i.body.url;l("Importing scores..."),await $(u,t)}async function $(t,e){let r=await fetch(t,{method:"GET",headers:{Authorization:`Bearer ${y("api-key")}`}}).then(n=>n.json());if(!r.success){l(`Terminal error: ${r.description}`);return}if(r.body.importStatus==="ongoing"){let n=typeof r.body.progress=="number"?r.body.progress.toString():r.body.progress.description;l(`Importing scores... ${r.description} Progress: ${n}`),setTimeout($,1e3,t,e);return}console.debug(r.body);let o=`${r.description} ${r.body.import.scoreIDs.length} scores`;if(r.body.import.errors.length>0){o=`${o}, ${r.body.import.errors.length} > 0 (check console for details)`;for(let n of r.body.import.errors)console.error(`${n.type}: ${n.message}`)}l(o)}function H(t,e){let r=t.querySelector(e)?.src;if(!r)throw new Error(`Could not determine image source for element ${t.outerHTML??t} with selector ${e}`);let o=r.split("/").pop()?.split(".")?.[0]?.split("_")?.[1]?.toUpperCase();if(typeof o>"u")throw new Error(`Could not determine difficulty from image URL ${r}`);return o}function U(t){let e=/([0-9]{4})\/([0-9]{1,2})\/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})/u.exec(t);if(!e||e.length!==6)throw new Error("Invalid timestamp format. Expected yyyy/MM/dd HH:mm.");let[r,o,n,i,u,s]=e,c=n.padStart(2,"0"),a=i.padStart(2,"0"),m=u.padStart(2,"0"),p=`${o}-${c}-${a}T${m}:${s}:00.000+09:00`;return new Date(p)}function v(t,e=!1){let r="CLEAR",o="NONE";return t.some(n=>n.includes("abplus.png"))?r="ALL BREAK+":t.some(n=>n.includes("ab.png"))?r="ALL BREAK":t.some(n=>n.includes("fc.png"))&&(r="FULL COMBO"),t.some(n=>n.includes("fb.png"))&&(o="FULL BELL"),t.some(n=>n.includes("lose.png"))&&(r="LOSS"),e&&t[0]?.includes("music_icon_back.png")&&(r="LOSS"),{noteLamp:r,bellLamp:o}}function M(t,e=!1){let r=t.querySelector(".m_5.l_h_10.break")?.innerText.trim();if(!r)throw new Error("Recent score card does not contain a title.");let o="songTitle";if(e)switch(r){case"Singularity":r=R(t),o="tachiSongID";break;case"Perfect Shining!!":r=B(t),o="inGameID";break}let n=H(t,".m_10 img"),i=t.querySelector(".f_r.f_12.h_10")?.innerText,u=i?U(i).valueOf():null,s=Number(t.querySelector(".technical_score_block .f_20, .technical_score_block_new .f_20")?.textContent.replace(/,/gu,"")),c=[...t.querySelectorAll(".clearfix.p_t_5.t_l.f_0 img")].map(p=>p.src),a=v(c),m={score:s,platinumScore:0,...a,matchType:o,identifier:r,difficulty:n,timeAchieved:u};try{m.judgements={cbreak:Number(t.querySelector(".score_critical_break .f_b")?.textContent?.replace(/,/gu,"")),break:Number(t.querySelector(".score_break .f_b")?.textContent?.replace(/,/gu,"")),hit:Number(t.querySelector(".score_hit .f_b")?.textContent?.replace(/,/gu,"")),miss:Number(t.querySelector(".score_miss .f_b")?.textContent?.replace(/,/gu,""))}}catch{}m.optional={};try{let p=t.querySelector('img[src*="score_max_combo.png"]')?.closest("tr")?.querySelector("td");m.optional.maxCombo=p?Number(p.textContent?.replace(/,/g,"")):void 0}catch{}try{m.optional.damage=Number(t.querySelector("tr.score_damage td")?.textContent?.replace(/,/gu,""))}catch{}try{let p=t.querySelector(".score_bell .f_b")?.textContent?.split("/");m.optional.bellCount=Number(p?.[0]?.replace?.(/,/gu,"")),m.optional.totalBellCount=Number(p?.[1]?.replace?.(/,/gu,""))}catch{}return m}async function*G(t=document){let e=[...t.querySelectorAll(".m_10")];for(let r=0;r<e.length;r++){l(`Fetching score ${r+1}/${e.length}...`);let o=e[r];if(!o){console.warn(`There was a hole in the NodeList? Element with index ${r} was null/undefined.`);continue}let n;try{n=M(o)}catch(c){console.error(`There was an error parsing score ${r+1}/${e.length}`,c);continue}let i=o.querySelector("input[name=idx]")?.value;if(!i){console.warn(`Could not retrieve parameters for fetching details of score with index ${r}. Yielding incomplete score.`),yield n;continue}let u=await f.sendPlaylogDetail(i).then(c=>c.text()),s=new DOMParser().parseFromString(u,"text/html");try{n=M(s,!0)}catch(c){console.error(`There was an error parsing score ${r+1}/${e.length}. Yielding incomplete score.`,c)}yield n}}function R(t){let e=t.querySelector("img.m_5.f_l")?.src;switch(e){case"https://ongeki-net.com/ongeki-mobile/img/music/ac5cab7a8a61d825.png":return"362";case"https://ongeki-net.com/ongeki-mobile/img/music/9cc53da5e1896b30.png":return"425";case"https://ongeki-net.com/ongeki-mobile/img/music/19bdf34c7aed1ee0.png":return"487";default:throw new Error(`Unknown Singularity image source: ${e}`)}}function B(t){if(t.textContent?.includes("\u661F\u54B2 \u3042\u304B\u308A Lv.1"))return"8003";if(t.textContent?.includes("\u661F\u54B2 \u3042\u304B\u308A Lv.39"))return"8091";throw new Error("Unknown Perfect Shining!! variant, check Lunatic chart list.")}async function*F(){for(let[t,e]of P.entries()){l(`Fetching scores for ${e}...`);let r=await f.sendMusicDifficulty(t).then(i=>i.text()),n=new DOMParser().parseFromString(r,"text/html").querySelectorAll('form[action="https://ongeki-net.com/ongeki-mobile/record/musicDetail/"]');for(let i of n){if(!i.querySelector(`.score_table.${e.toLowerCase()}_score_table.t_r.clearfix`))continue;let u=i.querySelector("div.music_label.p_5.break")?.textContent;if(!u)continue;let s="songTitle";if(u==="Singularity"){let d=new DOMParser().parseFromString(await f.sendMusicDetail(i.querySelector("input[name=idx]")?.value||"").then(T=>T.text()),"text/html");u=R(d),s="tachiSongID"}else if(u==="Perfect Shining!!"){let d=new DOMParser().parseFromString(await f.sendMusicDetail(i.querySelector("input[name=idx]")?.value||"").then(T=>T.text()),"text/html");u=B(d),s="inGameID"}let c=Number([...i.querySelectorAll(`td.score_value.${e.toLowerCase()}_score_value`)].map(d=>d.textContent.trim())[2].replace(/,/g,"")),a=[...i.querySelectorAll(".music_score_icon_area.t_r.f_0 img")].map(d=>d.src),m=v(a,!0),p=Number(i.querySelector(".t_r.platinum_high_score_text_block")?.textContent.split("/")[0].trim().replace(/,/g,""));yield{score:c,platinumScore:p,...m,matchType:s,identifier:u,difficulty:e.toUpperCase()}}}}async function S(t=document){let e=await Array.fromAsync(G(t));console.log("scores to import",e),await O({scores:e})}async function k(){let t=await Array.fromAsync(F());console.log("scores to import",t),await O({scores:t})}async function j(t){t.preventDefault();let e=document.querySelector("#api-key-form-key")?.value;if(!e||!/^[0-9a-f]+$/gu.test(e)){l("Invalid API key. Expected a hexadecimal string.");return}try{l("Verifying API key. The page will automatically reload once verification is successful.");let r=await fetch(`${h}/api/v1/users/me`,{headers:{Authorization:`Bearer ${e}`}}).then(o=>o.json());if(!r.success){l(`Invalid API key: ${r.description}`);return}b(I,e),location.reload()}catch(r){l(`Could not verify API key: ${r}`)}}function Y(){window.open(`${h}/client-file-flow/${C}`),document.querySelector("header")?.insertAdjacentHTML("afterend",`
	<div id="api-key-setup" style="background-color: #fff">
	  <form id="api-key-form">
		<input type="text" id="api-key-form-key" placeholder="Copy API Key here"/>
		<input type="submit" value="Save"/>
	  </form>
	</div>
	`),document.querySelector("#api-key-setup")?.addEventListener("submit",j)}function _(t,e){document.getElementById("kt-import-button")?.remove();let r=document.createElement("a");return r.id="kt-import-button",r.style.cssText="color:#fff;font-size:1em;font-weight:bold;padding:1rem;margin:1rem auto;display:block;width:-moz-fit-content;width:fit-content;text-decoration:none;border-radius:.5rem;border:3px solid #567;background-color:#234;text-align:center;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none;filter:brightness(0.7);transition:.2s",r.append(document.createTextNode(t)),document.querySelectorAll(".f_0")[1]?.insertAdjacentElement("afterend",r),r.onclick=e,r}function K(){let t=document.querySelector("#kt-import-button");if(!t){console.error("No import button found?");return}t.remove(),_("Confirm DANGEROUS operation",async()=>{await k()}).insertAdjacentHTML("afterend",`
	  <p id="kt-import-pb-warning" class="p_10" style="text-align: center; background-color: #fff">
		<span style="color: #f00">WARNING!</span>
		PB import is not recommended in general! PBs do not have timestamp data, and will not create
		sessions. Only import PBs <em>after</em> importing recent scores.
	  </p>
	`)}function q(){document.getElementById("kt-import-status")?.remove();let t=!!y(I),e=document.createElement("div");e.style.cssText=`
		color: rgb(255, 255, 255); 
		padding: 1rem; 
		margin: 1rem auto; 
		display: block; 
		width: 460px; 
		border-radius: 0.5rem; 
		border: 3px solid rgb(85, 102, 119); 
		background-color: rgb(34, 51, 68); 
		text-align: left; 
		line-height: 1.2rem; 
		font-size: 12px;
	`;let r="You don't have an API key set up. Please set up an API key before proceeding.",o=document.createElement("p");t||(o.append(document.createTextNode(r)),o.append(document.createElement("br")));let n=t?"Reconfigure API key (if broken)":"Set up API key",i=document.createElement("a");if(i.id="setup-api-key-onclick",i.append(document.createTextNode(n)),i.onclick=Y,o.append(i),e.append(o),t){let u=f,s=document.createElement("a"),c="Import recent scores (preferred)";s.onclick=async()=>{let p=await u.getPlaylog(),w=new DOMParser().parseFromString(await p.text(),"text/html");await S(w)},s.append(c),s.append(document.createElement("br")),e.append(s);let a=document.createElement("a"),m="Import all PBs";a.onclick=k,a.append(m),a.append(document.createElement("br")),e.append(a)}document.querySelectorAll(".f_0")[1]?.insertAdjacentElement("afterend",e),e.id="kt-import-status"}console.log("kt-ongeki-site-importer loaded");console.log("running ongeki import script on ",location.href);switch(location.pathname){case"/ongeki-mobile/record/musicGenre/":case"/ongeki-mobile/record/musicWord/":case"/ongeki-mobile/record/musicRank/":case"/ongeki-mobile/record/musicLevel/":{_("IMPORT ALL PBs",K);break}case"/ongeki-mobile/record/playlog/":{_("IMPORT RECENT SCORES",async()=>{await S(document)});break}case"/ongeki-mobile/home/":q();break}})();
