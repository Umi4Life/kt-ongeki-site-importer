(()=>{var h=class{static BUTTON_ID="kt-import-button";static BUTTON_STYLES="color:#fff;font-size:1em;font-weight:bold;padding:1rem;margin:1rem auto;display:block;width:-moz-fit-content;width:fit-content;text-decoration:none;border-radius:.5rem;border:3px solid #567;background-color:#234;text-align:center;cursor:pointer;-webkit-user-select:none;-ms-user-select:none;user-select:none;filter:brightness(0.7);transition:.2s";static create(e,r){document.getElementById(this.BUTTON_ID)?.remove();let t=document.createElement("a");return t.id=this.BUTTON_ID,t.style.cssText=this.BUTTON_STYLES,t.append(document.createTextNode(e)),document.querySelectorAll(".f_0")[1]?.insertAdjacentElement("afterend",t),t.onclick=r,t}static remove(){document.getElementById(this.BUTTON_ID)?.remove()}static get(){return document.getElementById(this.BUTTON_ID)}};var s=class{static STATUS_ELEMENT_ID="#kt-import-status";static update(e){let r=document.querySelector(this.STATUS_ELEMENT_ID);r||(r=document.createElement("p"),r.id=this.STATUS_ELEMENT_ID.substring(1),r.style.cssText="text-align: center; background-color: #fff;",document.querySelector(".title")?.insertAdjacentElement("afterend",r)),r.innerText=e}static clear(){document.querySelector(this.STATUS_ELEMENT_ID)?.remove()}};var N="__ktimport__",E="prod",P={prod:{baseUrl:"https://kamai.tachi.ac",clientId:"CI2a215ade610e60ee433a1f1faf0f2615f250e80d"}},x=P[E].baseUrl,A=P[E].clientId;var b="https://ongeki-net.com/ongeki-mobile/",C=!1,M=["BASIC","ADVANCED","EXPERT","MASTER","LUNATIC"];var u=class{static get(e){return localStorage.getItem(`${N}${e}_${E}`)}static set(e,r){localStorage.setItem(`${N}${e}_${E}`,r)}static getScores(){return this.get("scores")??"[]"}static setScores(e){this.set("scores",e)}static getClasses(){return this.get("classes")??"{}"}static setClasses(e){this.set("classes",e)}static getApiKey(){return this.get("api-key")}static setApiKey(e){this.set("api-key",e)}};var I=class extends Error{constructor(r,t){super(`ONGEKI-NET error ${r}: ${t}`);this.errCode=r;this.errDescription=t}},d=class extends Error{constructor(r,t){super(`Parse error in ${r}: ${t}`);this.context=r}};var y=class{constructor(e){this.baseUrl=e;this.domParser=new DOMParser,e.endsWith("/")||(this.baseUrl=e.substring(0,e.length-1))}domParser;async getPlaylog(){return this.request("/record/playlog/")}async getPlaylogDetail(e){return this.request(`/record/playlogDetail/?idx=${e}`)}async getMusicDifficulty(e){return this.request(`/record/musicGenre/search/?genre=99&diff=${e}`)}async getMusicDetail(e){return this.request(`/record/musicDetail/?idx=${encodeURIComponent(e)}`)}async request(e,r){let t=`${this.baseUrl}${e}`,n=await fetch(t,r),o=new URL(n.url);if(n.status===503)throw s.update("ONGEKI.NET is currently under maintenance. Please try again later."),new Error("ONGEKI.NET is under maintenance");return o.pathname.endsWith("/error/")&&this.handleErrorResponse(await n.text()),o.pathname.includes("/rightLimit/")&&this.handleRateLimitResponse(await n.text()),n}handleErrorResponse(e){let t=this.domParser.parseFromString(e,"text/html").querySelectorAll(".block.text_l .font_small"),n=t[0],o=n?.textContent?Number(n.textContent.split(": ")[1]):-1,i=t.length>1&&t[1].textContent?t[1].textContent:"An unknown error occurred.";throw s.update(`ONGEKI-NET error ${o}: ${i}`),new I(o,i)}handleRateLimitResponse(e){let t=this.domParser.parseFromString(e,"text/html").querySelectorAll(".block.text_l .font_small"),n=t[0],o=n?.textContent?Number(n.textContent.split(": ")[1]):-1,i=t.length>1&&t[1].textContent?t[1].textContent:"Account has no subscription (https://gw.sega.jp/gateway/login/?product_name=ongeki).";throw s.update(`ONGEKI-NET error ${o}: ${i}`),new I(o,i)}};var k=class{static async submitScores(e){let{scores:r=[]}=e,t=JSON.parse(u.getScores());if(t.push(...r),u.setScores(JSON.stringify(t)),t.length===0){s.update("Nothing to import.");return}let n={meta:{game:"ongeki",playtype:"Single",service:"site-importer"},scores:t};if(C&&E==="prod"){console.log("Currently in development mode. Scores will not be uploaded to Kamaitachi.");let a=new Blob([JSON.stringify(n,null,4)],{type:"application/json"}),l=URL.createObjectURL(a),f=document.createElement("a");f.href=l,f.download=`kt-ongeki-site-importer-${new Date().valueOf()}.json`,f.click();return}let o=JSON.stringify(n);document.querySelector("#kt-import-button")?.remove(),s.update("Submitting scores...");let i;try{i=await fetch(`${x}/ir/direct-manual/import`,{method:"POST",headers:{authorization:`Bearer ${u.getApiKey()}`,"content-type":"application/json","x-user-intent":"true"},body:o}).then(a=>a.json())}catch(a){s.update(`Could not submit scores to Kamaitachi: ${a}
Your scores are saved in browser storage and will be submitted next import.`);return}if(u.setScores("[]"),u.setClasses("{}"),!i.success){s.update(`Could not submit scores to Kamaitachi: ${i.description}`);return}let g=i.body.url;s.update("Importing scores..."),await this.pollStatus(g,e)}static async pollStatus(e,r){let t=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${u.getApiKey()}`}}).then(o=>o.json());if(!t.success){s.update(`Terminal error: ${t.description}`);return}if(t.body.importStatus==="ongoing"){let o=typeof t.body.progress=="number"?t.body.progress.toString():t.body.progress.description;s.update(`Importing scores... ${t.description} Progress: ${o}`),setTimeout(()=>this.pollStatus(e,r),1e3);return}console.debug(t.body);let n=`${t.description} ${t.body.import.scoreIDs.length} scores`;if(t.body.import.errors.length>0){n=`${n}, ${t.body.import.errors.length} errors (check console for details)`;for(let o of t.body.import.errors)console.error(`${o.type}: ${o.message}`)}s.update(n)}};var L=class{static extractFromImage(e,r){let t=e.querySelector(r)?.src;if(!t)throw new d("DifficultyExtractor",`Could not determine image source for element with selector ${r}`);let n=t.split("/").pop()?.split(".")?.[0]?.split("_")?.[1]?.toUpperCase();if(typeof n>"u")throw new d("DifficultyExtractor",`Could not determine difficulty from image URL ${t}`);return n.toUpperCase()}};var v=class{static calculate(e,r=!1){let t="CLEAR",n="NONE";return e.some(o=>o.includes("abplus.png"))?t="ALL BREAK+":e.some(o=>o.includes("ab.png"))?t="ALL BREAK":e.some(o=>o.includes("fc.png"))&&(t="FULL COMBO"),e.some(o=>o.includes("fb.png"))&&(n="FULL BELL"),e.some(o=>o.includes("lose.png"))&&(t="LOSS"),r&&e[0]?.includes("music_icon_back.png")&&(t="LOSS"),{noteLamp:t,bellLamp:n}}};var w=class{static parse(e){let r=/([0-9]{4})\/([0-9]{1,2})\/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})/u.exec(e);if(!r||r.length!==6)throw new Error("Invalid timestamp format. Expected yyyy/MM/dd HH:mm.");let[t,n,o,i,g,a]=r,l=o.padStart(2,"0"),f=i.padStart(2,"0"),c=g.padStart(2,"0"),m=`${n}-${l}-${f}T${c}:${a}:00.000+09:00`;return new Date(m)}};var O=["Singularity","Perfect Shining!!","Hand in Hand"],T=class{static isDupeSong(e){return O.includes(e)}static convertTitleToTachiID(e,r){switch(e){case"Singularity":return this.processSingularityToTachiID(r);case"Perfect Shining!!":return this.processPerfectShiningToTachiID(r);case"Hand in Hand":return this.processHandinHandToTachiID(r);default:throw new d("DupeSongConverter.convertTitleToTachiID",`Unknown dupe song title: ${e}`)}}static processHandinHandToTachiID(e){return"337"}static processSingularityToTachiID(e){let r=e.querySelector("img.m_5.f_l")?.src;switch(r){case"https://ongeki-net.com/ongeki-mobile/img/music/ac5cab7a8a61d825.png":return"362";case"https://ongeki-net.com/ongeki-mobile/img/music/9cc53da5e1896b30.png":return"425";case"https://ongeki-net.com/ongeki-mobile/img/music/19bdf34c7aed1ee0.png":return"487";default:throw new d("DupeSongConverter.processSingularityToTachiID",`Unknown Singularity image source: ${r}`)}}static processPerfectShiningToTachiID(e){if(e.textContent?.includes("\u661F\u54B2 \u3042\u304B\u308A Lv.1"))return"817";if(e.textContent?.includes("\u661F\u54B2 \u3042\u304B\u308A Lv.39"))return"69";throw new d("DupeSongConverter.processPerfectShiningToTachiID","Unknown Perfect Shining!! variant.")}};var _=class{static ongekiNetClient=new y(b);static parseRecentScore(e,r=!1){let t=e.querySelector(".m_5.l_h_10.break")?.innerText.trim();if(!t)throw new d("ScoreParser.parseRecentScore","Recent score card does not contain an identifier.");let n="songTitle";T.isDupeSong(t)&&(t=T.convertTitleToTachiID(t,e),n="tachiSongID");let o=L.extractFromImage(e,".m_10 img"),i=e.querySelector(".f_r.f_12.h_10")?.innerText,g=i?w.parse(i).valueOf():null,a=Number(e.querySelector(".technical_score_block .f_20, .technical_score_block_new .f_20")?.textContent.replace(/,/gu,"")),l=[...e.querySelectorAll(".clearfix.p_t_5.t_l.f_0 img")].map(m=>m.src),f=v.calculate(l),c={score:a,platinumScore:0,...f,matchType:n,identifier:t,difficulty:o,timeAchieved:g};try{c.judgements={cbreak:Number(e.querySelector(".score_critical_break .f_b")?.textContent?.replace(/,/gu,"")),break:Number(e.querySelector(".score_break .f_b")?.textContent?.replace(/,/gu,"")),hit:Number(e.querySelector(".score_hit .f_b")?.textContent?.replace(/,/gu,"")),miss:Number(e.querySelector(".score_miss .f_b")?.textContent?.replace(/,/gu,""))}}catch{}c.optional={};try{let m=e.querySelector('img[src*="score_max_combo.png"]')?.closest("tr")?.querySelector("td");c.optional.maxCombo=m?Number(m.textContent?.replace(/,/g,"")):void 0}catch{}try{c.optional.damage=Number(e.querySelector("tr.score_damage td")?.textContent?.replace(/,/gu,""))}catch{}try{let m=e.querySelector(".score_bell .f_b")?.textContent?.split("/");c.optional.bellCount=Number(m?.[0]?.replace?.(/,/gu,"")),c.optional.totalBellCount=Number(m?.[1]?.replace?.(/,/gu,""))}catch{}return c}static async parsePersonalBestScore(e,r){let t=e.querySelector("div.music_label.p_5.break")?.textContent;if(!t)throw new d("ScoreParser.parsePersonalBestScore","Personal best score does not contain a title.");let n="songTitle";if(T.isDupeSong(t)){let c=new DOMParser().parseFromString(await this.ongekiNetClient.getMusicDetail(e.querySelector("input[name=idx]")?.value||"").then(m=>m.text()),"text/html");t=T.convertTitleToTachiID(t,c),n="tachiSongID"}let o=Number([...e.querySelectorAll(`td.score_value.${r.toLowerCase()}_score_value`)].map(c=>c.textContent.trim())[2].replace(/,/g,"")),i=[...e.querySelectorAll(".music_score_icon_area.t_r.f_0 img")].map(c=>c.src),{noteLamp:g,bellLamp:a}=v.calculate(i),l=Number(e.querySelector(".t_r.platinum_high_score_text_block")?.textContent.split("/")[0].trim().replace(/,/g,""));return{score:o,platinumScore:l,noteLamp:g,bellLamp:a,matchType:n,identifier:t,difficulty:r}}};var S=class{static ongekiNetClient=new y(b);static async importRecentScores(e=document){let r=[];for await(let t of this.traverseRecents(e))r.push(t);console.log("scores to import:",r),await k.submitScores({scores:r})}static async importPersonalBests(){let e=[];for await(let r of this.traversePersonalBests())e.push(r);console.log("scores to import:",e),await k.submitScores({scores:e})}static async*traverseRecents(e=document){let r=[...e.querySelectorAll(".m_10")];for(let t=0;t<r.length;t++){s.update(`Fetching score ${t+1}/${r.length}...`);let n=r[t];if(!n){console.warn(`There was a hole in the NodeList? Element with index ${t} was null/undefined.`);continue}let o;try{o=_.parseRecentScore(n)}catch(l){console.error(`There was an error parsing score ${t+1}/${r.length}`,l);continue}let i=n.querySelector("input[name=idx]")?.value;if(!i){console.warn(`Could not retrieve parameters for fetching details of score with index ${t}. Yielding incomplete score.`),yield o;continue}let g=await this.ongekiNetClient.getPlaylogDetail(i).then(l=>l.text()),a=new DOMParser().parseFromString(g,"text/html");try{o=_.parseRecentScore(a,!0)}catch(l){console.error(`There was an error parsing score ${t+1}/${r.length}. Yielding incomplete score.`,l)}yield o}}static async*traversePersonalBests(){for(let[e,r]of M.entries()){s.update(`Fetching scores for ${r}...`);let t=await this.ongekiNetClient.getMusicDifficulty(e).then(i=>i.text()),o=new DOMParser().parseFromString(t,"text/html").querySelectorAll('form[action="https://ongeki-net.com/ongeki-mobile/record/musicDetail/"]');for(let i of o)i.querySelector(`.score_table.${r.toLowerCase()}_score_table.t_r.clearfix`)&&(yield await _.parsePersonalBestScore(i,r))}}};var D=class{static ongekiNetClient=new y(b);static WARNING_ID="kt-import-pb-warning";static showPbImportWarning(){if(!h.get()){console.error("No import button found?");return}h.remove(),h.create("Confirm DANGEROUS operation",async()=>{document.getElementById(this.WARNING_ID)?.remove(),await S.importPersonalBests()});let r=`
            <p id="${this.WARNING_ID}" class="p_10" style="text-align: center; background-color: #fff">
                <span style="color: #f00">WARNING!</span>
                PB import is not recommended in general! PBs do not have timestamp data, and will not create
                sessions. Only import PBs <em>after</em> importing recent scores.
            </p>
        `;h.get()?.insertAdjacentHTML("afterend",r)}static addNav(){s.clear();let e=!!u.getApiKey(),r=document.createElement("div");r.style.cssText=`
			color: rgb(255, 255, 255); 
			padding: 1rem; 
			margin: 1rem auto; 
			display: block; 
			width: 460px; 
			border-radius: 0.5rem; 
			border: 3px solid rgb(85, 102, 119); 
			background-color: rgb(34, 51, 68); 
			text-align: left; 
			line-height: 1.2rem; 
			font-size: 12px;
		`;let t=document.createElement("p");e||(t.append(document.createTextNode("You don't have an API key set up. Please set up an API key before proceeding.")),t.append(document.createElement("br")));let n=e?"Reconfigure API key (if broken)":"Set up API key",o=document.createElement("a");if(o.id="setup-api-key-onclick",o.append(document.createTextNode(n)),o.onclick=()=>this.setupApiKey(),t.append(o),r.append(t),e){let i=document.createElement("a"),g="Import recent scores (preferred)";i.onclick=async()=>{let f=await this.ongekiNetClient.getPlaylog(),c=new DOMParser().parseFromString(await f.text(),"text/html");await S.importRecentScores(c)},i.append(g),i.append(document.createElement("br")),r.append(i);let a=document.createElement("a"),l="Import all PBs";a.onclick=()=>S.importPersonalBests(),a.append(l),a.append(document.createElement("br")),r.append(a)}document.querySelectorAll(".f_0")[1]?.insertAdjacentElement("afterend",r),r.id="kt-import-status"}static setupApiKey(){window.open(`${x}/client-file-flow/${A}`),document.querySelector("header")?.insertAdjacentHTML("afterend",`
			<div id="api-key-setup" style="background-color: #fff">
			<form id="api-key-form">
				<input type="text" id="api-key-form-key" placeholder="Copy API Key here"/>
				<input type="submit" value="Save"/>
			</form>
			</div>
		`),document.querySelector("#api-key-setup")?.addEventListener("submit",r=>{this.submitApiKey(r)})}static async submitApiKey(e){e.preventDefault();let r=document.querySelector("#api-key-form-key")?.value;if(!r||!/^[0-9a-f]+$/gu.test(r)){s.update("Invalid API key. Expected a hexadecimal string.");return}try{s.update("Verifying API key. The page will automatically reload once verification is successful.");let t=await fetch(`${x}/api/v1/users/me`,{headers:{Authorization:`Bearer ${r}`}}).then(n=>n.json());if(!t.success){s.update(`Invalid API key: ${t.description}`);return}u.setApiKey(r),location.reload()}catch(t){s.update(`Could not verify API key: ${t}`)}}};console.log("kt-ongeki-site-importer loaded");console.log("running ongeki import script on ",location.href);var $=location.pathname.replace(/\/$/,"");switch($){case"/ongeki-mobile/record/musicGenre":case"/ongeki-mobile/record/musicWord":case"/ongeki-mobile/record/musicRank":case"/ongeki-mobile/record/musicLevel":{h.create("IMPORT ALL PBs",()=>{D.showPbImportWarning()});break}case"/ongeki-mobile/record/playlog":{h.create("IMPORT RECENT SCORES",async()=>{await S.importRecentScores(document)});break}case"/ongeki-mobile/home":D.addNav();break}})();
